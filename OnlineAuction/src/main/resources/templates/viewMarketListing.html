<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" style="height: 100%;">
    <head>
        <meta charset="ISO-8859-1">
        <title> Market Listing </title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
        <link th:href="@{/styles/button.css}" rel="stylesheet"/>
        <link th:href="@{/styles/landing.css}" rel="stylesheet"/>
        <link th:href="@{/styles/employee_page.css}" rel="stylesheet"/>
        <style>
            #page {
            display: flex;
            height: 100vh;
            }
            #website-title {
            margin-left: 8px;
            margin-right: 8px;
            font-size: 12px;
            }
            .center{
            margin-left: auto;
            margin-right: auto;
            object-fit: contain;
            }
            .image-preview{
            vertical-align: middle;
            }
            div.auction-price-container{
            text-align: center;
        	margin-top: 10px;
        	font-weight: bold;
        	border-radius: 12px; /* Rounded corners */
        	padding: 10px; /* Padding around text */
        	width: fit-content; /* Shrink to fit the content */
       	    margin-left: auto; /* Centering */
       	    margin-right: auto; /* Centering */
        	font-family: 'Poppins', sans-serif; /* Using imported Poppins font */
        	color: #333; /* Text color */
            }
        </style>
    </head>
    <body>
        <div th:insert="header :: header"></div>
        <div class="modal fade" id="deletePopup" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deletePopup">Update Listing</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>This will delete your listing - are you sure?</p>
                    </div>
                    <div class="modal-footer">
                        <form method="post" action="#" th:action="@{/viewMarketListing/deleteListing/{listingId}(listingId=${currListing.id})}" th:object="${paymentDetails}">
                            <button type="submit" class="btn btn-danger" name="delete"> Delete </button>
                        </form>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="page">
            <div class="card mx-auto h-100 w-100">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                      <li th:each="cat, iterStat : ${categories}" class="breadcrumb-item" th:classappend="${iterStat.last} ? 'active' : ''">
                          <span th:if="${!iterStat.last}">
                              <a href="#" th:text="${cat}"></a>
                          </span>
                          <span th:if="${iterStat.last}" th:text="${cat}"></span>
                      </li>
                    </ol>
                </nav>
                <div class="card-body">
                    <div class="row mb-4">
                        <!-- Left Column: Image -->
                        <div class="col-lg-7">
                            <div class="card h-60" th:if="${currListing.coverImage != null && !currListing.coverImage.isEmpty()}">
                                <div class="img-container">
                                    <button style="height:40px; margin-left: 10px" onclick="changeImageBackward()">&#8592;</button>
                                    <img class="card-img-bottom center col-sm-2" style=" height:50vh;" id="showWidget" th:src="@{/listingImages/{image}(image = ${currListing.coverImage})}" />
                                    <button style="height:40px; margin-right: 10px" onclick="changeImageForward()">&#8594;</button>
                                </div>
                            </div>
                            <div class="card h-100" th:unless="${currListing.coverImage != null && !currListing.coverImage.isEmpty()}">
                                <div class="d-flex justify-content-center card-header">
                                    <h2>No Image Provided</h2>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column: Seller Details and Action Buttons -->
                        <div class="col-lg-5">
                            <div class="seller-display d-flex align-items-center mb-3">
                                <!-- Seller Avatar -->
                                <img th:if="${seller.userImage == null}" th:src="@{/images/userImages/default_user_icon.png}" alt="Seller Avatar" class="rounded-circle me-3" style="width:50px; height:50px;"></img>
								<img th:if="${seller.userImage != null}" th:src="@{/images/userImages/{icon}(icon = ${seller.userImage})}" alt="Seller Avatar" class="rounded-circle me-3" style="width:50px; height:50px;"></img>
                            
                                <!-- Seller Details -->
                                <div>
                                    <!-- Seller Name -->
                                    <h5 th:text="${seller.displayName}" class="mb-1"></h5>
                            
                                    <!-- Seller Rating -->
                                    <div class="d-flex align-items-center">
                                        <!-- Filled Stars -->
                                        <th:block th:each="star : ${#numbers.sequence(1, sellerRating.rating)}">
                                            <span class="text-warning">★</span>
                                        </th:block>
                                        
                                        <!-- Unfilled Stars -->
                                        <th:block th:each="star : ${#numbers.sequence(sellerRating.rating + 1, 5)}">
                                            <span class="text-muted">★</span>
                                        </th:block>

                                        <!-- Rating Value -->
                                        <span th:text="${sellerRating.rating}" class="me-2"></span>

                                        <!-- Number of Ratings -->
                                        <span class="ms-2 text-muted" th:text=" - ${sellerRating.numRatings} + ' ratings'"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <!-- For Buyers -->
                            <div th:if="${isBuyer}" class="mt-4">
                                <form th:if="${isBuyer}" id="buy-product" class="d-flex flex-column align-items-center" action="#" th:action="@{/viewMarketListing/attemptPurchase}" th:object=${newTransaction} method="post">
                                    <!-- Buy Now and Bid Now -->
                                    <div class="d-flex justify-content-center mb-3">
                                        <div class="me-3">
                                            <input class="btn btn-success" id="purchaseButton" name="buyProduct" type="submit" th:value="'Buy Now for $' + ${currListing.pricePerItem}" />
                                        </div>
                                        <div>
                                            <input class="btn btn-success" id="bidButton" name="placeBid" type="submit" value="Bid Now" />
                                        </div>
                                    </div>
                                    
                                    <!-- Widget Description -->
                                    <div class="mb-4 text-center">
                                        <h2 class="display-4" th:text="${widget.name}"></h2> 
                                        <p class="lead" th:text="${widget.description}"></p>
                                    </div>

                                    <!-- Add to Wishlist and Back -->
                                    <div class="d-flex justify-content-center mb-3">
                                        <div class="me-3">
                                            <a class="btn btn-success">Add to Wishlist</a>
                                        </div>
                                        <div>
                                            <a class="btn btn-danger" href="/BrowseWidgetsButton">Back</a>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <!-- For Sellers -->
                            <div th:if="${!isBuyer}" class="mt-4">
                                <form th:if="${!isBuyer}" id="update-listing" class="d-flex flex-column align-items-center" action="#" th:action="@{/viewMarketListing/editListing}" th:object=${currListing} method="post">
                                    <!-- Update Listing and Delete Listing -->
                                    <div class="d-flex justify-content-center mb-3">
                                        <div class="me-3">
                                            <input class="btn btn-primary" id="updateListing" name="updateListing" type="submit" value="Update">
                                        </div>
                                        <div class="me-3">
                                            <a class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deletePopup"> Delete Listing </a>
                                        </div>
                                        <div>
                                            <a class="btn btn-danger" href="/BrowseWidgetsButton"> Back </a>
                                        </div>
                                    </div>

                                    <!-- Widget Description -->
                                    <div class="mb-4 text-center">
                                        <h2 class="display-4" th:text="${widget.name}"></h2> 
                                        <p class="lead" th:text="${widget.description}"></p>
                                    </div>
                                </form>
                            </div>

                        </div>
                    </div>
                    
                    <!-- Widget Attributes Table -->
                    <div class="d-flex justify-content-center mb-2">
                        <h2>Product Information</h2>
                    </div>
                    <div class="col-lg-6 mx-auto">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Specification</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="attribute : ${attributes}">
                                    <td th:text="${attribute.attributeKey}"></td>
                                    <td th:text="${attribute.value}"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <script th:inline="javascript">
            const basePrice = /*[[${currListing.pricePerItem}]]*/ 0.0;
            const qtyBoughtElement = document.getElementById('qtyBought');
            const purchaseButtonElement = document.getElementById('purchaseButton');
            function updatePrice() {
                const qty = parseInt(qtyBoughtElement.value);
                const totalPrice = (qty * basePrice).toFixed(2);
                purchaseButtonElement.value = 'Buy Now for $' + totalPrice;
            }
            if (qtyBoughtElement) {
                qtyBoughtElement.addEventListener('change', updatePrice);
            }
            updatePrice();

            /*<![CDATA[*/
            var image = document.querySelector('#showWidget');
            var len = /*[[${images.length}]]*/ '0';
            const images = /*[[${images}]]*/ 'd';
            var x = images.indexOf(/*[[${currListing.coverImage}]]*/);
            function changeImageForward(){
                if(len==1){
                    window.alert("Only one image has been uploaded for this item");
                }
                else{
                    x++;
                    if(x >= len){
                        x = 0;
                    }
                    if(images[x] == images[0] && x > 0){
                        x++;
                    }
                    image.src = '/listingImages/' + images[x];
                }
            }
            function changeImageBackward(){
                if(len==1){
                    window.alert("Only one image has been uploaded for this item")
                }
                else{
                    x--;
                    if(x < 0){
                        x = len-1;
                    }
                    if(images[x] == images[0] && x > 0){
                        x--;
                    }
                    image.src = '/listingImages/' + images[x];
                }
            }
            /*]]>*/
        </script>
    </body>
</html>