<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" style="height: 100%;">
    <head>
        <meta charset="ISO-8859-1">
        <title> Market Listing </title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        
        <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
        
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
        
        <link th:href="@{/styles/button.css}" rel="stylesheet"/>
        <link th:href="@{/styles/landing.css}" rel="stylesheet"/>
        <link th:href="@{/styles/browse.css}" rel="stylesheet"/>
        <link th:href="@{/styles/employee_page.css}" rel="stylesheet"/>
		<link th:href="@{/styles/viewMarketListing.css}" rel="stylesheet"/>		
		
        <style>
        	div.auction-price-container{
	            text-align: center;
	            margin-top: 10px;
	            font-weight: bold;
	            border-radius: 12px; /* Rounded corners */
	            padding: 10px; /* Padding around text */
	            width: fit-content; /* Shrink to fit the content */
	            margin-left: auto; /* Centering */
	            margin-right: auto; /* Centering */
	            font-family: 'Poppins', sans-serif; /* Using imported Poppins font */
	            color: #333; /* Text color */
          }
        </style>
    </head>
    <body>
        <div th:insert="header :: header"></div>
        
        <div id="page">
            <div class="card mx-auto h-70 w-100" style="height: 90%;">
   
                <nav aria-label="breadcrumb" class="custom-breadcrumb">
                    <ol class="breadcrumb">
                        <li th:each="cat, iterStat : ${categories}" class="breadcrumb-item" th:classappend="${iterStat.last} ? 'active' : ''">
                            <span th:if="${!iterStat.last}">
                                <a href="#" th:text="${cat}"></a>
                            </span>
                            <span th:if="${iterStat.last}" th:text="${cat}"></span>
                        </li>
                    </ol>
                </nav>

                <div class="card-body">
                    <div class="row mb-4">
                        <!-- Left Column: Image -->
                        <div class="col-lg-5">
                            <div class="card h-60" th:if="${currListing.coverImage != null && !currListing.coverImage.isEmpty()}">
                                <div class="img-container">
                                    <button style="height:40px; position: absolute; left: 10px; top: 50%; transform: translateY(-50%);" onclick="changeImageBackward()">&#8592;</button>
                                    <img class="card-img-bottom" id="showWidget" th:src="@{/listingImages/{image}(image = ${currListing.coverImage})}" />
                                    <button style="height:40px; position: absolute; right: 10px; top: 50%; transform: translateY(-50%);" onclick="changeImageForward()">&#8594;</button>
                                </div>
                            </div>
                            <div class="card h-100" th:unless="${currListing.coverImage != null && !currListing.coverImage.isEmpty()}">
                                <div class="d-flex justify-content-center card-header">
                                    <h2>No Image Provided</h2>
                                </div>
                            </div>
                            <!-- Listing: Current Bid -->
                            <div class="d-flex justify-content-center mt-3"> <!-- mt-3 for some margin at the top -->
        						<div class="auction-price-container">
            						<span>Current Bid: </span>
            						<span th:text="'$' + ${currListing.auctionPrice}"></span>
        						</div>
    						</div>
                        </div>
                                         
                     
                        <!-- Right Column: Seller Details and Action Buttons -->
                        <div class="col-lg-5">
                            <div class="seller-display d-flex align-items-center mb-3">
                                <!-- Seller Avatar -->
                                <img th:if="${seller.userImage == null}" th:src="@{/images/userImages/default_user_icon.png}" alt="Seller Avatar" class="rounded-circle me-3" style="width:50px; height:50px;"></img>
								<img th:if="${seller.userImage != null}" th:src="@{/images/userImages/{icon}(icon = ${seller.userImage})}" alt="Seller Avatar" class="rounded-circle me-3" style="width:50px; height:50px;"></img>
                            
                                <!-- Seller Details -->
                                <div>
                                    <!-- Seller Name -->
                                    <h5 th:text="${seller.username}" class="mb-1"></h5>
                            
                                    <!-- Seller Rating -->
                                    <div class="d-flex align-items-center">
                                        <!-- Filled Stars -->
                                        <th:block th:each="star : ${#numbers.sequence(1, sellerRating.rating)}">
                                            <span class="text-warning">★</span>
                                        </th:block>
                                        
                                        <!-- Unfilled Stars -->
                                        <th:block th:each="star : ${#numbers.sequence(sellerRating.rating + 1, 5)}">
                                            <span class="text-muted">★</span>
                                        </th:block>

                                        <!-- Rating Value -->
                                        <span th:text="${sellerRating.rating}" class="me-2"></span>

                                        <!-- Number of Ratings -->
                                        <span class="ms-2 text-muted" th:text=" ${sellerRating.numRatings} + ' rating(s)'"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Widget Description -->
                            <div class="mb-4 mt-4 text-center">
                                <h2 class="display-4" th:text="${widget.name}"></h2> 
                                <p class="lead" th:text="${widget.description}"></p>
                            </div>
                      
                      		<!-- Display messages -->
                    		<div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
                    		<div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

                            <!-- Action Buttons -->
                            <div th:if="${isBuyer}" class="mt-4">
                            	<form th:if="${isBuyer}" id="buy-product" class="row g-3 d-flex justify-content-center my-2" action="#" th:action="@{/viewMarketListing/attemptPurchase}" th:object=${newTransaction} method="post">
                                	<div class="col-auto">
                                    	<label for="qtyBought" class="col-form-label"> Number to Buy: </label>
                                    </div>
                                    <div class="col-auto">
                                    	<input id="qtyBought" class="form-control" name="qtyBought" type="number" th:field="*{qtyBought}" placeholder="Number to Buy" min="1" th:max="${currListing.qtyAvailable}" value="0" required></input>
                                    </div>
                                    <div class="col-auto">
                                        <input class="btn btn-success" id="purchaseButton" name="buyProduct" type="submit" th:value="'Buy Now for $' + ${currListing.pricePerItem}" />
                                    </div>
                            	</form>
                              	<div class="row g-3 d-flex justify-content-center my-2">	
									  								  
                                	<!-- Add to Watchlist Button -->                                	
                                	<!-- watchlist alert | NOT WORKING -->
                                  	<div if="${successMessage}" class="alert alert-success alert-dismissible fade d-none" role="alert">
									  	<p th:text="${successMessage}"></p>
									  	<button type="button" class="close" data-dismiss="alert" aria-label="Close">
									    	<span aria-hidden="true">&times;</span>
									 	</button>
									</div> 
                                	
                                	<!-- try to add modal from line 247 -->
									<div class="col-auto">
                                    	<form id="addToWatchlistForm" th:action="@{/viewMarketListing/wishlistItem/{id}(id = ${currListing.getId()})}" method="post" th:if="${!foundInWatchlist}">
                                          	<button class="btn btn-success" id="addToWatchlistButton" data-toggle="modal" data-target="#watchlistModal">
												  Add to Watchlist
                                          	</button>
                                      	</form>
                                      	
                                  	</div>
                                  	
                                  	<div class="col-auto">
                                    	<form id="removeFromWatchlistForm" th:action="@{/viewMarketListing/delWishlistItem/{id}(id = ${currListing.getId()})}" method="post" th:if="${foundInWatchlist}">
                                          	<button class="btn btn-success" id="addToWatchlistButton" data-toggle="modal" data-target="#watchlistModal">
												  Remove from Watchlist
                                          	</button>
                                      	</form>
                                      	
                                  	</div>
                                  	
                                  	<!-- SHOWING MODAL BUT NOT ADDING TO WATCHLIST
									<script>
									    // When the form is submitted
									    $("#addToWatchlistForm").submit(function(event) {
									        event.preventDefault(); // Prevent the default form submission
									
									        // Show the modal
									        $("#watchlistModal").modal("show");
									
									        // Make an AJAX request to the server to process the form data
									        $.ajax({
									            type: "POST",
									            url: "/viewMarketListing/wishlistItem/{id}", // Replace with the actual URL
									            data: {
									                id: $("#currListingId").val() // Get the ID value from somewhere
									            },
									            success: function(response) {
									                // Handle the success response from the server
									                // You can close the modal or update its content here
									                $("#watchlistModal .modal-body").html("Item added to watchlist"); // Update modal content
									                setTimeout(function() {
									                    $("#watchlistModal").modal("hide"); // Hide the modal after a delay
									                }, 2000); // Adjust the delay as needed
									            },
									            error: function(error) {
									                // Handle any error that occurs during the AJAX request
									                console.error(error);
									                // Optionally, you can display an error message in the modal here
									            }
									        });
									    });
									</script>-->      	
									                          
                              		<div class="col-auto">
                                    	<input type="hidden" name="listingId" th:value="${currListing.id}"/>  
                                      	<input class="btn btn-success" id="bidButton" name="placeBid" type="button" value="Bid Now" data-bs-toggle="modal" data-bs-target="#bidModal"/>
                                  	</div>

                                  	<div class="col-auto">
                                      	<a class="btn btn-danger" href="/BrowseWidgetsButton">Back</a>
                                  	</div>
                              </div> 		                                 
                              </div> 	

                            <!-- For Sellers -->
                            <div th:if="${!isBuyer}" class="mt-4">
                                    <!-- Update Listing and Delete Listing -->
                                    <div class="d-flex justify-content-center mb-3">
                                        <input class="btn btn-primary" id="update-listing" name="update-listing" type="button" value="Update" data-bs-toggle="modal" data-bs-target="#updateModal" />
                                    </div>
                                    <div class="d-flex justify-content-center mb-3">
                                        <a class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deletePopup"> Delete Listing </a>
                                    </div>
                                    <div class="d-flex justify-content-center mb-3">
                                        <a class="btn btn-danger" href="/BrowseWidgetsButton"> Back </a>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Widget Attributes Table -->
                <div>
	                <div class="d-flex justify-content-center mb-2">
	                    <h2>Product Information</h2>
	                </div>
	                <div class="col-lg-6 mx-auto">
	                    <table class="table table-striped">
	                        <thead>
	                            <tr>
	                                <th>Specification</th>
	                                <th>Value</th>
	                            </tr>
	                        </thead>
	                        <tbody>
	                            <tr th:each="attribute : ${attributes}">
	                                <td th:text="${attribute.attributeKey}"></td>
	                                <td th:text="${attribute.value}"></td>
	                            </tr>
	                        </tbody>
	                    </table>
	                </div>
				</div>
				
            </div>
        </div>

        <!-- Modals -->
        <!-- Delete Listing Confirmation -->
        <div class="modal fade" id="deletePopup" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deletePopup">Update Listing</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>This will delete your listing - are you sure?</p>
                    </div>
                    <div class="modal-footer">
                        <form method="post" action="#" th:action="@{/viewMarketListing/deleteListing/{listingId}(listingId=${currListing.id})}" th:object="${paymentDetails}">
                            <button type="submit" class="btn btn-danger" name="delete"> Delete </button>
                        </form>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Bid Modal -->
        <div class="modal fade" id="bidModal" tabindex="-1" aria-labelledby="bidModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="bidModalLabel">Place a Bid</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form th:action="@{/updateBid}" method="post" onsubmit="return validateBid();">
                    <div class="mb-3">
								      <span th:text="'Auction Price: $' + ${currListing.auctionPrice}"></span>
                      <label for="bidAmount" class="form-label">Bid Amount</label>
                      <input type="number" class="form-control" id="bidAmount" name="bidAmount" data-auction-price="${currListing.auctionPrice}">
                    </div>
                    <input type="hidden" name="listingId" th:value="${currListing.id}"/>
                    <input class="btn btn-success" id="bidButton" name="placeBid" type="submit" value="Bid Now" onclick="return confirmBid();"/>
                  </form>
                </div>
              </div>
            </div>
          </div>
          
        <!-- Watchlist Modal - need to add functionality -->
    	<div class="modal fade" id="watchlistModal" tabindex="-1" aria-labelledby="watchlistModalLabel" aria-hidden="true">
        	<div class="modal-dialog modal-dialog-centered">
         		<div class="modal-content">
            		<div class="modal-header">
              			<h5 class="modal-title" id="watchlistModalLabel">Watchlist</h5>
              			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            		</div>
            		<div class="modal-body">						
                		<div class="mb-3">
							<p>Item added to watchlist</p>
                		</div>
            		</div>
          		</div>
        	</div>
      	</div>

        <!-- Update Listing Modal -->
        <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="updateModalLabel">Update Listing</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form action="#" method="post" id="update-listing" th:action="@{/viewMarketListing/editListing}" th:object="${currListing}">
                    <input type="hidden" th:field="*{id}">
                    <div class="mb-3">
                      <p class="form-label" th:text="'Current Price: $' + ${currListing.pricePerItem}"></p>
                      <label for="pricePerItem" class="form-label" >New Price</label>
                      <input type="number" class="form-control" id="pricePerItem" name="pricePerItem" placeholder="${currListing.pricePerItem}" th:field="*{pricePerItem}" min="0.0" value="0.0" step="0.01" required>
                      <label for="qtyAvailable" class="form-label" >New Quantity</label>
                      <input type="number" class="form-control" id="qtyAvailable" name="qtyAvailable" placeholder="${currListing.qtyAvailable}" th:field="*{qtyAvailable}" min="0" value="0" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Listing</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          
        
          <script th:inline="javascript">
            // Price update logic
            const basePrice = /*[[${currListing.pricePerItem}]]*/ 0.0;
            const qtyBoughtElement = document.getElementById('qtyBought');
            const purchaseButtonElement = document.getElementById('purchaseButton');
        
            function updatePrice() {
                if (qtyBoughtElement && purchaseButtonElement) {
                    const qty = parseInt(qtyBoughtElement.value);
                    const totalPrice = (qty * basePrice).toFixed(2);
                    purchaseButtonElement.value = 'Buy Now for $' + totalPrice;
                }
            }
        
            if (qtyBoughtElement) {
                qtyBoughtElement.addEventListener('change', updatePrice);
            }
            updatePrice();
            
            function confirmBid() {
              return confirm("Are you sure you want to place this bid?");
            }
        
            // Image change logic
            const image = document.querySelector('#showWidget');
            const images = /*[[${images}]]*/ [];
            let x = images.indexOf(/*[[${currListing.coverImage}]]*/ '');
        
            function changeImageForward() {
                if (images.length === 1) {
                    window.alert("Only one image has been uploaded for this item");
                } else {
                    x++;
                    if (x >= images.length) {
                        x = 0;
                    }
                    image.src = '/listingImages/' + images[x];
                }
            }
        
            function changeImageBackward() {
                if (images.length === 1) {
                    window.alert("Only one image has been uploaded for this item");
                } else {
                    x--;
                    if (x < 0) {
                        x = images.length - 1;
                    }
                    image.src = '/listingImages/' + images[x];
                }
            }
            
            function addWatchlist() { // alert the user when they add an item to their watchlist
              var message = 'The item has been added to your watchlist.';
              // Display the alert
              alert(message);
            }
   			
        </script>        
    </body>
</html>